<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø´Ø­Ù† - Ù†Ø³Ø±ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        .action-button {
            background-color: #519fff;
            color: white;
            padding: 64px 20px;
            margin: 5px;
            border: none;
            border-radius: 35px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .action-button:hover {
            background-color: #4179cc;
        }

        .logout-top {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .logout-small-btn {
            background-color: #e52a2a;
            color: #fff;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-small-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="welcomeMsg"></div>

        <div class="logout-top">
            <button type="button" id="logout" class="logout-small-btn">Ø®Ø±ÙˆØ¬</button>
        </div>
        <div id="buttonlist" style="text-align:center; margin-bottom: 20px;">
            <button type="button" id="viewShipments" class="action-button">Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø­Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>
            <button type="button" id="showForm" class="action-button">ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø­Ù†</button>
        </div>

        <form id="shippingForm" style="display: none;">
            <div class="section-block">
                <div class="section-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡</div>
                <input type="text" name="Ø§Ù„Ø§Ø³Ù…" placeholder="Ø§Ù„Ø§Ø³Ù…" required>
                <div class="row">
                    <input type="text" name="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" required>
                    <input type="text" name="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" required>
                </div>
                <div class="row">
                    <input type="text" name="Ø§Ù„Ø­ÙŠ" placeholder="Ø§Ù„Ø­ÙŠ" required>
                    <input type="text" name="Ø§Ù„Ø´Ø§Ø±Ø¹" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹" required>
                </div>
            </div>

            <div class="section-block">
                <div class="section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø­Ù†Ø©</div>
                <input type="number" name="Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø±ÙˆØ¯" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø±ÙˆØ¯" required>
                <div class="weight-group">
                    <input type="number" name="Ø§Ù„ÙˆØ²Ù†" placeholder="Ø§Ù„ÙˆØ²Ù†" required>
                    <div class="unit-switch">
                        <input type="radio" id="kg" name="Ù†ÙˆØ¹ Ø§Ù„ÙˆØ²Ù†" value="ÙƒÙŠÙ„ÙˆØ¬Ø±Ø§Ù…" checked>
                        <label for="kg" class="unit-btn">Kg</label>
                        <input type="radio" id="g" name="Ù†ÙˆØ¹ Ø§Ù„ÙˆØ²Ù†" value="Ø¬Ø±Ø§Ù…">
                        <label for="g" class="unit-btn">g</label>
                    </div>
                </div>
            </div>

            <div class="g-recaptcha" data-sitekey="6LeMiVQrAAAAAKtiT1DJcih5Rohp_3k-vyAWyvhA"></div>
            <button type="submit" id="submitButton">Ø¥Ø±Ø³Ø§Ù„</button>
        </form>

        <div id="toast" class="toast" style="display:none;">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</div>
    </div>

    <script>
        function showToast(msg) {
            var t = document.getElementById("toast");
            t.innerText = msg;
            t.style.display = "block";
            setTimeout(() => { t.style.display = "none"; }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function () {
            var name = sessionStorage.getItem('savedName');
            var code = sessionStorage.getItem('savedCode');

            if (!name || !code) {
                window.location.href = 'login.html';
                return;
            }

            fetch('get_username.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, code: code })
            })
            .then(res => res.json())
            .then(result => {
                if (result.barcode) {
                    sessionStorage.setItem('savedBarcode', result.barcode);
                }
            });

            document.getElementById("welcomeMsg").innerHTML =
                "<span class='hello'>Ù…Ø±Ø­Ø¨Ø§Ù‹</span> " +
                "<span class='user'>" + name + "</span>";
            document.getElementById("welcomeMsg").style.display = "block";

            window.currentUserName = name;
            window.currentUserCode = code;

            document.getElementById('viewShipments').onclick = function () {
                window.location.href = 'my-shipments.html';
            };

            document.getElementById('showForm').onclick = function () {
                const form = document.getElementById('shippingForm');
                form.style.display = (form.style.display === "none") ? "block" : "none";
                form.scrollIntoView({ behavior: "smooth" });
            };

            document.getElementById('logout').onclick = function () {
                sessionStorage.clear();
                window.location.href = 'login.html';
            };
        });

        document.getElementById('shippingForm').addEventListener('submit', function (e) {
            e.preventDefault();

            var submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

            let response = grecaptcha.getResponse();
            if (response.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù†Ùƒ Ù„Ø³Øª Ø±ÙˆØ¨ÙˆØª.');
                submitButton.disabled = false;
                submitButton.innerText = "Ø¥Ø±Ø³Ø§Ù„";
                return;
            }

            const formData = new FormData(this);
            let message = 'ğŸšš ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø­Ù†Ø©:\n\n';
            let dataObj = {};
            formData.forEach((value, key) => {
                if (key !== 'g-recaptcha-response') {
                    message += `${key}: ${value}\n`;
                }
                dataObj[key] = value;
            });

            if (window.currentUserCode) {
                dataObj['user_code'] = window.currentUserCode;
            }
            if (window.currentUserName) {
                dataObj['user_name'] = window.currentUserName;
            }

            dataObj['barcode'] = sessionStorage.getItem('savedBarcode');

            fetch('save_shipment.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataObj)
            })
            .then(response => response.json())
            .then(result => {
                if (result.ok) {
                    fetch('telegram_send.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: message, user_code: window.currentUserCode })
                    })
                    .then(response => response.json())
                    .then(() => {
                        document.getElementById('shippingForm').reset();
                        grecaptcha.reset();
                        showToast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!');
                        submitButton.disabled = false;
                        submitButton.innerText = "Ø¥Ø±Ø³Ø§Ù„";
                    });
                } else {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø´Ø­Ù†Ø©:\n" + result.error);
                    submitButton.disabled = false;
                    submitButton.innerText = "Ø¥Ø±Ø³Ø§Ù„";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
                submitButton.disabled = false;
                submitButton.innerText = "Ø¥Ø±Ø³Ø§Ù„";
            });
        });
    </script>
</body>

</html>